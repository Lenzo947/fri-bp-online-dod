@page "/online-chat"
@inject HttpClient httpClient
@inject NavigationManager navigationManager

<h1>Online deň otvorených dverí</h1>
<p>
    Pridávanie otázok a reakcií je <b>otvorené</b>.
</p>

<hr class="mb-4" />

@if (state == STATE.NONE) // if app is in STATE NONE (initial state)
{
    <button @onclick="ToCreate" class="btn btn-primary mb-5"><span class="oi oi-chat mr-2"></span>Napísať správu</button>
}

@if (state == STATE.CREATE) // if app is in CREATE state
{
    <EditForm Model="MessageModel" OnValidSubmit="Add">
        <DataAnnotationsValidator />

        <label for="title">Nová správa</label>

        <InputTextArea @bind-Value="MessageModel.Text"
                       class="form-control mb-2"
                       id="title"
                       placeholder="Správa..."
                       rows="5"
                       oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';"></InputTextArea>

        <div class="mb-2">
            <ValidationSummary />
        </div>

        <div class="mb-5">
            <button type="submit" class="btn btn-primary"><span class="oi oi-envelope-closed mr-2"></span>Odoslať</button>
            <button @onclick="ToNone" type="button" class="btn btn-primary float-right"><span class="oi oi-x mr-2"></span>Zrušiť správu</button>
        </div>
    </EditForm>
}

@if (state == STATE.EDIT_DELETE) // if app is in EDIT_DELETE state
{
    <EditForm Model="MessageModel" OnValidSubmit="Edit">
        <DataAnnotationsValidator />

        <label for="title">Úprava správy</label>

        <InputTextArea @bind-Value="MessageModel.Text"
                       class="form-control mb-2"
                       id="title"
                       placeholder="Správa..."
                       rows="5"
                       oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';"></InputTextArea>

        <div class="mb-2">
            <ValidationSummary />
        </div>

        <div class="mb-5">
            <button type="submit" class="btn btn-primary"><span class="oi oi-pencil mr-2"></span>Upraviť</button>
            <button @onclick="Delete" type="button" class="btn btn-primary"><span class="oi oi-trash mr-2"></span>Odstrániť</button>
            <button @onclick="ToNone" type="button" class="btn btn-primary float-right"><span class="oi oi-x mr-2"></span>Zrušiť úpravy</button>
        </div>

    </EditForm>
}

@if (Messages != null) // wait for all messages to load first
{
    foreach (Message msg in Messages.Reverse())
    {
        <MessageCard msg="@msg" Classes="mb-4"/>

        @*<div class="card mb-4">
            <div class="card-body p-3">
                <h5 class="card-title">
                    Anonym
                    <button @onclick="(() => ShowEdit(msg.Id))" class="btn btn-sm btn-primary float-right"><span class="oi oi-pencil mr-2"></span>Upraviť</button>
                </h5>
                <div class="card-subtitle mb-2">
                    <div class="badge badge-info px-2 py-1">
                        <span class="oi oi-thumb-up"></span>
                        @msg.ThumbsUpCount
                    </div>
                    <div class="badge badge-secondary px-2 py-1">@msg.TimeSent.ToLocalTime().ToString("dd.MM. yyyy HH:mm:ss")</div>
                    <small class="text-muted d-none">ID správy: @msg.Id</small>
                </div>
                <p class="card-text p-2">@msg.Text</p>
            </div>
        </div>*@
    }
}

@code {

    protected Message MessageModel { get; set; } = new Message();

    public virtual ICollection<Message> Messages { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    protected async Task Load()
    {
        Messages = await httpClient.GetFromJsonAsync<ICollection<Message>>("https://localhost:44317/api/messages");
    }

    public async Task Add()
    {
        var payload = new { Text = MessageModel.Text, ThumbsUpCount = new Random().Next(0, 100) };

        var response = await httpClient.PostAsJsonAsync("https://localhost:44317/api/messages", payload);

        //state = STATE.NONE;

        if (response.IsSuccessStatusCode)
        {
            ClearFields();

            await Load();

            //var message = await response.Content.ReadFromJsonAsync<Message>();

            //navigationManager.NavigateTo("online-chat", true);
        }
    }

    protected async Task ShowEdit(int id)
    {
        MessageModel = await httpClient.GetFromJsonAsync<Message>("https://localhost:44317/api/messages/" + id);

        state = STATE.EDIT_DELETE;
    }

    public async Task Edit()
    {
        var response = await httpClient.PutAsJsonAsync("https://localhost:44317/api/messages/" + MessageModel.Id, MessageModel);

        if (response.IsSuccessStatusCode)
        {
            ToNone();

            await Load();


            //var message = await response.Content.ReadFromJsonAsync<Message>();

            //navigationManager.NavigateTo("online-chat", true);
        }
    }

    public async Task Delete()
    {
        var response = await httpClient.DeleteAsync("https://localhost:44317/api/messages/" + MessageModel.Id);

        if (response.IsSuccessStatusCode)
        {
            ToNone();

            await Load();

            //var message = await response.Content.ReadFromJsonAsync<Message>();

            //navigationManager.NavigateTo("online-chat", true);
        }
    }

    protected void ClearFields()
    {
        MessageModel.Text = null;
    }

    private enum STATE
    {
        NONE,
        CREATE,
        EDIT_DELETE
    }
    STATE state = STATE.NONE;

    protected void ToCreate()
    {
        ClearFields();
        state = STATE.CREATE;
    }

    protected void ToNone()
    {
        ClearFields();
        state = STATE.NONE;
    }
}
